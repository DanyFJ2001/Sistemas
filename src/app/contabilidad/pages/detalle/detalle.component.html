<div class="detalle-container">
  
  <!-- Loading -->
  <div class="loading" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Cargando detalles...</p>
  </div>

  <!-- Content -->
  <div *ngIf="!isLoading && validationResult">
    
    <!-- Header -->
    <div class="page-header">
      <button class="btn-back" (click)="goBack()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Volver
      </button>
      <div class="header-title">
        <h1 class="page-title">Detalle de Factura</h1>
        <p class="page-subtitle">{{ fileName }}</p>
      </div>
    </div>

    <!-- Status Banner -->
    <div class="status-banner" [ngClass]="getStatusClass(validationResult.status)">
      <div class="status-icon">
        {{ getStatusIcon(validationResult.status) }}
      </div>
      <div class="status-content">
        <h2>{{ getStatusText(validationResult.status) }}</h2>
        <p>{{ validationResult.aiAnalysis }}</p>
      </div>
      <div class="status-meta">
        <div class="meta-item">
          <span class="meta-label">Confianza</span>
          <span class="meta-value">{{ (validationResult.confidence * 100).toFixed(0) }}%</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Tiempo</span>
          <span class="meta-value">{{ validationResult.processingTime.toFixed(2) }}s</span>
        </div>
      </div>
    </div>

    <!-- Actions Bar -->
    <div class="actions-bar">
      <button class="btn-action" (click)="downloadXML()" *ngIf="invoice">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Descargar XML
      </button>
      
      <button class="btn-action" (click)="resendEmail()" *ngIf="invoice && validationResult.status === 'rejected'" [disabled]="isSendingEmail">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
        {{ isSendingEmail ? 'Enviando...' : 'Reenviar Email' }}
      </button>
      
      <button class="btn-action" (click)="copyDetails()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        Copiar Detalles
      </button>
    </div>

    <!-- Two Column Layout -->
    <div class="content-grid">
      
      <!-- Left Column -->
      <div class="left-column">
        
        <!-- Información General -->
        <div class="info-card" *ngIf="invoice">
          <h3 class="card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            Información General
          </h3>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">ID Factura</span>
              <span class="info-value">#{{ invoice.id }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Archivo</span>
              <span class="info-value">{{ invoice.fileName }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Fecha Emisión</span>
              <span class="info-value">{{ formatDate(invoice.date) }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Fecha Subida</span>
              <span class="info-value">{{ formatDate(invoice.uploadDate) }}</span>
            </div>
          </div>
        </div>

        <!-- Datos del Proveedor -->
        <div class="info-card" *ngIf="invoice">
          <h3 class="card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Datos del Proveedor
          </h3>
          <div class="info-grid">
            <div class="info-item full-width">
              <span class="info-label">Razón Social</span>
              <span class="info-value">{{ invoice.supplier }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">RUC</span>
              <span class="info-value ruc">{{ invoice.ruc }}</span>
            </div>
            <div class="info-item" *ngIf="invoice.xmlData?.emailComprador">
              <span class="info-label">Email</span>
              <span class="info-value">{{ invoice.xmlData?.emailComprador }}</span>
            </div>
            <div class="info-item" *ngIf="invoice.xmlData?.telefonoComprador">
              <span class="info-label">Teléfono</span>
              <span class="info-value">{{ invoice.xmlData?.telefonoComprador }}</span>
            </div>
            <div class="info-item full-width" *ngIf="invoice.xmlData?.direccionComprador">
              <span class="info-label">Dirección</span>
              <span class="info-value">{{ invoice.xmlData?.direccionComprador }}</span>
            </div>
          </div>
        </div>

        <!-- Conceptos -->
        <div class="info-card" *ngIf="hasConceptos">
          <h3 class="card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"></line>
              <line x1="8" y1="12" x2="21" y2="12"></line>
              <line x1="8" y1="18" x2="21" y2="18"></line>
              <line x1="3" y1="6" x2="3.01" y2="6"></line>
              <line x1="3" y1="12" x2="3.01" y2="12"></line>
              <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
            Conceptos
          </h3>
          <div class="table-wrapper">
            <table class="concepts-table">
              <thead>
                <tr>
                  <th>Cant.</th>
                  <th>Descripción</th>
                  <th>P. Unit.</th>
                  <th>Desc.</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let concepto of conceptos">
                  <td>{{ concepto.cantidad }}</td>
                  <td class="desc-cell">{{ concepto.descripcion }}</td>
                  <td>{{ formatCurrency(concepto.precioUnitario) }}</td>
                  <td>{{ formatCurrency(concepto.descuento) }}</td>
                  <td class="total-cell">{{ formatCurrency(concepto.precioTotal) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- Right Column -->
      <div class="right-column">
        
        <!-- Totales -->
        <div class="info-card totals-card" *ngIf="invoice">
          <h3 class="card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
            Totales
          </h3>
          <div class="totals-list">
            <div class="total-item" *ngIf="hasSubtotal0()">
              <span>Subtotal 0%</span>
              <span>{{ formatCurrency(getSubtotal0()) }}</span>
            </div>
            <div class="total-item" *ngIf="hasSubtotal5()">
              <span>Subtotal 5%</span>
              <span>{{ formatCurrency(getSubtotal5()) }}</span>
            </div>
            <div class="total-item" *ngIf="hasSubtotal15()">
              <span>Subtotal 15%</span>
              <span>{{ formatCurrency(getSubtotal15()) }}</span>
            </div>
            <div class="total-item subtotal">
              <span>Subtotal sin impuesto</span>
              <span>{{ formatCurrency(invoice.subtotal) }}</span>
            </div>
            <div class="total-item" *ngIf="hasDescuento()">
              <span>Descuento</span>
              <span>{{ formatCurrency(getDescuento()) }}</span>
            </div>
            <div class="total-item" *ngIf="invoice.iva">
              <span>IVA</span>
              <span>{{ formatCurrency(invoice.iva) }}</span>
            </div>
            <div class="total-item grand-total">
              <span>TOTAL</span>
              <span>{{ formatCurrency(invoice.amount) }}</span>
            </div>
          </div>
        </div>

        <!-- Errores -->
        <div class="info-card errors-card" *ngIf="hasValidationErrors">
          <h3 class="card-title error-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            Errores Detectados ({{ validationErrors.length }})
          </h3>
          <div class="errors-list">
            <div class="error-item" *ngFor="let error of validationErrors; let i = index">
              <div class="error-number">{{ i + 1 }}</div>
              <div class="error-content">
                <h4>{{ error.field }}</h4>
                <p>{{ error.message }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Advertencias -->
        <div class="info-card warnings-card" *ngIf="hasValidationWarnings">
          <h3 class="card-title warning-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Advertencias ({{ validationWarnings.length }})
          </h3>
          <div class="warnings-list">
            <div class="warning-item" *ngFor="let warning of validationWarnings; let i = index">
              <div class="warning-number">{{ i + 1 }}</div>
              <div class="warning-content">
                <h4>{{ warning.field }}</h4>
                <p>{{ warning.message }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Validaciones Técnicas -->
        <div class="info-card" *ngIf="hasValidaciones">
          <h3 class="card-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Validaciones Técnicas
          </h3>
          <div class="validations-list">
            <div class="validation-item" [class.valid]="validaciones.rucValido">
              <span class="validation-icon">{{ validaciones.rucValido ? '✓' : '✗' }}</span>
              <span>RUC Válido</span>
            </div>
            <div class="validation-item" [class.valid]="validaciones.claveAccesoValida">
              <span class="validation-icon">{{ validaciones.claveAccesoValida ? '✓' : '✗' }}</span>
              <span>Clave de Acceso</span>
            </div>
            <div class="validation-item" [class.valid]="validaciones.calculosCorrectos">
              <span class="validation-icon">{{ validaciones.calculosCorrectos ? '✓' : '✗' }}</span>
              <span>Cálculos Correctos</span>
            </div>
            <div class="validation-item" [class.valid]="validaciones.fechaValida">
              <span class="validation-icon">{{ validaciones.fechaValida ? '✓' : '✗' }}</span>
              <span>Fecha Válida</span>
            </div>
            <div class="validation-item" [class.valid]="validaciones.ambienteValido">
              <span class="validation-icon">{{ validaciones.ambienteValido ? '✓' : '✗' }}</span>
              <span>Ambiente Válido</span>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

</div>