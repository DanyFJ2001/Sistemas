<!-- src/app/pages/contabilidad/contabilidad.component.html -->
<div class="contabilidad-page">
  
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-info">
      <h1 class="page-title">üì¶ Control de Inventario con Pistola</h1>
      <p class="page-subtitle">Escanea c√≥digos de barras para verificar inventario</p>
    </div>

    <div class="header-actions" *ngIf="fileLoaded">
      <div class="scanner-status" [class.active]="scannerEnabled" (click)="toggleScanner()">
        <span class="scanner-dot"></span>
        {{ scannerEnabled ? 'Scanner Activo' : 'Scanner Inactivo' }}
      </div>

      <!-- NUEVO: Bot√≥n para procesar facturas con IA -->
      <button class="btn-primary" (click)="abrirModalFactura()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <circle cx="12" cy="13" r="2"></circle>
          <path d="M12 15v4"></path>
        </svg>
        <span class="btn-text">Procesar Factura IA</span>
      </button>

      <button class="btn-secondary" (click)="imprimirCodigosBarras()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 6 2 18 2 18 9"></polyline>
          <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
          <rect x="6" y="14" width="12" height="8"></rect>
        </svg>
        <span class="btn-text">Imprimir C√≥digos</span>
      </button>

      <button class="btn-secondary" (click)="exportarExcel()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <span class="btn-text">Exportar Todo</span>
      </button>

      <button class="btn-primary" (click)="exportarSoloPistoleados()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 11l3 3L22 4"></path>
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
        </svg>
        <span class="btn-text">Exportar Pistoleados</span>
      </button>
    </div>
  </div>

  <!-- Upload Section -->
  <div *ngIf="!fileLoaded" class="upload-section">
    <div class="upload-card">
      <div class="upload-icon">üìä</div>
      <h2>Cargar archivo Excel</h2>
      <p>Arrastra tu archivo o haz clic para seleccionar</p>
      
      <input 
        type="file" 
        id="fileInput" 
        accept=".xlsx,.xls" 
        (change)="onFileSelected($event)"
        hidden
      >
      <label for="fileInput" class="btn-upload">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Seleccionar Archivo Excel
      </label>

      <div class="upload-hint">
        <p><strong>Columnas esperadas:</strong></p>
        <code>Producto | Codigo | Referencia | Combo | REFE | Cantidad | U. Medida | Costo | Grupo II | Grupo III | Estado</code>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="fileLoaded" class="main-content">
    
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card stat-total">
        <div class="stat-icon">üì¶</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.total }}</span>
          <span class="stat-label">Total Productos</span>
        </div>
      </div>

      <div class="stat-card stat-pistoleado">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.pistoleados }}</span>
          <span class="stat-label">Pistoleados</span>
        </div>
      </div>

      <div class="stat-card stat-parcial">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.parciales }}</span>
          <span class="stat-label">Parciales</span>
        </div>
      </div>

      <div class="stat-card stat-pendiente">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.noPistoleados }}</span>
          <span class="stat-label">Pendientes</span>
        </div>
      </div>

      <div class="stat-card stat-progress">
        <div class="stat-icon">üìà</div>
        <div class="stat-info">
          <span class="stat-value">{{ stats.porcentaje }}%</span>
          <span class="stat-label">Progreso</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="stats.porcentaje"></div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
      <div class="search-box">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input 
          type="text" 
          placeholder="Buscar por c√≥digo, producto, referencia..." 
          class="search-input"
          (input)="onSearch($event)"
        >
      </div>

      <div class="filter-buttons">
        <button class="filter-btn" [class.active]="filtroEstado === 'todos'" (click)="onFilterChange('todos')">
          Todos ({{ stats.total }})
        </button>
        <button class="filter-btn pistoleado" [class.active]="filtroEstado === 'pistoleado'" (click)="onFilterChange('pistoleado')">
          ‚úÖ Pistoleados ({{ stats.pistoleados }})
        </button>
        <button class="filter-btn parcial" [class.active]="filtroEstado === 'parcial'" (click)="onFilterChange('parcial')">
          ‚ö†Ô∏è Parciales ({{ stats.parciales }})
        </button>
        <button class="filter-btn pendiente" [class.active]="filtroEstado === 'no_pistoleado'" (click)="onFilterChange('no_pistoleado')">
          ‚è≥ Pendientes ({{ stats.noPistoleados }})
        </button>
      </div>

      <div class="action-buttons">
        <button class="btn-sm btn-warning" (click)="resetearTodo()">
          üîÑ Resetear Pistoleado
        </button>
        <label for="fileInputAdd" class="btn-sm btn-info">
          üìÑ Subir Excel
        </label>
        <input 
          type="file" 
          id="fileInputAdd" 
          accept=".xlsx,.xls" 
          (change)="onFileSelected($event)"
          hidden
        >
        <button class="btn-sm btn-danger" (click)="eliminarTodosLosProductos()">
          üóëÔ∏è Eliminar Todo
        </button>
      </div>
    </div>

    <!-- File Info -->
    <div class="file-info-bar">
      <span class="file-name">üìÑ {{ fileName }}</span>
      <span class="file-count">{{ productosFiltrados.length }} de {{ productos.length }} productos</span>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>{{ loadingMessage || 'Procesando...' }}</p>
    </div>

    <!-- Products Table -->
    <div *ngIf="!loading && productosFiltrados.length > 0" class="products-table-container">
      <table class="products-table">
        <thead>
          <tr>
            <th class="th-barcode">C√≥digo Barras</th>
            <th>C√≥digo</th>
            <th>Referencia</th>
            <th>Producto</th>
            <th class="th-center">Cantidad</th>
            <th class="th-center">Pistoleado</th>
            <th class="th-center">Diferencia</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let producto of productosFiltrados" 
              [id]="'producto-' + producto.id"
              [class]="getEstadoClass(producto.estadoPistola)">
            
            <!-- C√≥digo de barras miniatura -->
            <td class="td-barcode">
              <img 
                *ngIf="producto.barcodeDataUrl" 
                [src]="producto.barcodeDataUrl" 
                class="barcode-thumbnail"
                (click)="verCodigoBarras(producto)"
                title="Click para ampliar"
              >
            </td>

            <td class="td-codigo">
              <span class="codigo-badge">{{ producto.codigo }}</span>
            </td>

            <td class="td-referencia">
              <strong>{{ producto.referencia }}</strong>
              <small *ngIf="producto.refe">{{ producto.refe }}</small>
            </td>

            <td class="td-producto">
              {{ producto.producto }}
            </td>

            <td class="td-center">
              <span class="cantidad-badge">{{ formatNumber(producto.cantidad) }} {{ producto.uMedida }}</span>
            </td>

            <td class="td-center">
              <span class="cantidad-pistoleada" [class.completo]="producto.cantidadPistoleada >= producto.cantidad">
                {{ formatNumber(producto.cantidadPistoleada) }}
              </span>
            </td>

            <td class="td-center">
              <span class="diferencia" [class.warning]="producto.cantidad - producto.cantidadPistoleada > 0">
                {{ formatNumber(producto.cantidad - producto.cantidadPistoleada) }}
              </span>
            </td>

            <td>
              <span class="estado-badge" [ngClass]="getEstadoClass(producto.estadoPistola)">
                {{ getEstadoLabel(producto.estadoPistola) }}
              </span>
            </td>

            <td class="td-actions">
              <button class="action-btn view-btn" (click)="verCodigoBarras(producto)" title="Ver c√≥digo">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="7" y1="7" x2="7" y2="17"></line>
                  <line x1="10" y1="7" x2="10" y2="17"></line>
                  <line x1="13" y1="7" x2="13" y2="17"></line>
                  <line x1="17" y1="7" x2="17" y2="17"></line>
                </svg>
              </button>
              <button class="action-btn check-btn" (click)="marcarPistoleado(producto)" title="Marcar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </button>
              <button 
                *ngIf="producto.estadoPistola !== 'no_pistoleado'"
                class="action-btn reset-btn" 
                (click)="desmarcarPistoleado(producto)" 
                title="Desmarcar"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                  <path d="M3 3v5h5"></path>
                </svg>
              </button>
              <button class="action-btn delete-btn" (click)="eliminarProducto(producto)" title="Eliminar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && productosFiltrados.length === 0 && productos.length > 0" class="empty-state">
      <div class="empty-icon">üîç</div>
      <h3>No se encontraron productos</h3>
      <p>Intenta con otros filtros o t√©rminos de b√∫squeda</p>
    </div>
  </div>
</div>

<!-- ========== MODAL DE CANTIDAD MEJORADO CON SUMAR/RESTAR ========== -->
<div *ngIf="showCantidadModal" class="modal-overlay" (click)="closeCantidadModal()">
  <div class="modal-content cantidad-modal" (click)="$event.stopPropagation()">
    
    <!-- Header del Modal -->
    <div class="modal-header" [class.success]="operacionModal === 'sumar'" [class.warning]="operacionModal === 'restar'">
      <h2>{{ operacionModal === 'sumar' ? '‚ûï Devolver al Inventario' : 'üì¶ Pistolar Producto' }}</h2>
      <button class="close-btn" (click)="closeCantidadModal()">‚úï</button>
    </div>
    
    <div class="modal-body" *ngIf="productoSeleccionado">
      
      <!-- Info del producto escaneado -->
      <div class="scanned-product-info">
        <img 
          *ngIf="productoSeleccionado.barcodeDataUrl" 
          [src]="productoSeleccionado.barcodeDataUrl" 
          class="scanned-barcode"
        >
        <div class="product-details">
          <h3>{{ productoSeleccionado.referencia }}</h3>
          <p class="product-name">{{ productoSeleccionado.producto }}</p>
          <p class="product-code">C√≥digo: <strong>{{ productoSeleccionado.codigo }}</strong></p>
        </div>
      </div>

      <!-- Info de cantidades -->
      <div class="cantidad-info">
        <div class="info-row">
          <span>Cantidad esperada:</span>
          <strong>{{ productoSeleccionado.cantidad }} {{ productoSeleccionado.uMedida }}</strong>
        </div>
        <div class="info-row">
          <span>Ya pistoleado:</span>
          <strong class="pistoleado-actual">{{ productoSeleccionado.cantidadPistoleada }}</strong>
        </div>
        <div class="info-row highlight">
          <span>Disponible para pistolar:</span>
          <strong>{{ productoSeleccionado.cantidad - productoSeleccionado.cantidadPistoleada }}</strong>
        </div>
      </div>

      <!-- ========== SELECTOR DE OPERACI√ìN (SUMAR / RESTAR) ========== -->
      <div class="operacion-selector">
        <button 
          class="op-btn sumar" 
          [class.active]="operacionModal === 'sumar'"
          (click)="setOperacion('sumar')"
          [disabled]="productoSeleccionado.cantidadPistoleada === 0">
          <span class="op-icon">‚ûï</span>
          <span class="op-text">Devolver</span>
          <small style="font-size: 11px; color: #6b7280;">Deshacer pistolado</small>
        </button>
        <button 
          class="op-btn restar" 
          [class.active]="operacionModal === 'restar'"
          (click)="setOperacion('restar')"
          [disabled]="(productoSeleccionado.cantidad - productoSeleccionado.cantidadPistoleada) === 0">
          <span class="op-icon">üì¶</span>
          <span class="op-text">Pistolar</span>
          <small style="font-size: 11px; color: #6b7280;">Registrar uso</small>
        </button>
      </div>

      <!-- Input de cantidad -->
      <div class="cantidad-input-group">
        <label>Cantidad a {{ operacionModal === 'sumar' ? 'devolver' : 'pistolar' }}:</label>
        <div class="cantidad-controls">
          <button class="qty-btn minus" (click)="cantidadIngresada = cantidadIngresada > 1 ? cantidadIngresada - 1 : 1">‚àí</button>
          <input 
            type="number" 
            [(ngModel)]="cantidadIngresada" 
            min="1" 
            [max]="cantidadMaximaDisponible"
            class="cantidad-input"
            (keyup.enter)="confirmarCantidad()"
            autofocus
          >
          <button class="qty-btn plus" (click)="cantidadIngresada = cantidadIngresada + 1">+</button>
        </div>
        
        <!-- Botones r√°pidos -->
        <div class="quick-buttons">
          <button (click)="cantidadIngresada = 1">1</button>
          <button (click)="cantidadIngresada = 5">5</button>
          <button (click)="cantidadIngresada = 10">10</button>
          <button 
            (click)="cantidadIngresada = cantidadMaximaDisponible"
            [disabled]="cantidadMaximaDisponible <= 0">
            Todo ({{ cantidadMaximaDisponible }})
          </button>
        </div>
      </div>

      <!-- Vista previa del resultado -->
      <div class="preview-result" [class.sumar]="operacionModal === 'sumar'" [class.restar]="operacionModal === 'restar'">
        <span class="preview-label">Resultado:</span>
        <span class="preview-calculation">
          {{ productoSeleccionado.cantidadPistoleada }} 
          <span class="operador">{{ operacionModal === 'sumar' ? '‚àí' : '+' }}</span> 
          {{ cantidadIngresada }} = 
          <strong class="preview-total">{{ calcularResultado() }}</strong>
        </span>
      </div>

    </div>

    <!-- Footer con botones de acci√≥n -->
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeCantidadModal()">Cancelar</button>
      <button 
        class="btn-confirmar" 
        [class.btn-success]="operacionModal === 'sumar'"
        [class.btn-restar]="operacionModal === 'restar'"
        (click)="confirmarCantidad()"
        [disabled]="cantidadIngresada < 1 || cantidadMaximaDisponible <= 0">
        {{ operacionModal === 'sumar' ? '‚ûï Confirmar Devoluci√≥n' : 'üì¶ Confirmar Pistolado' }} ({{ cantidadIngresada }})
      </button>
    </div>
  </div>
</div>

<!-- ========== MODAL DE FACTURA CON IA ========== -->
<div *ngIf="showFacturaModal" class="modal-overlay" (click)="closeFacturaModal()">
  <div class="modal-content factura-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>ü§ñ Procesar Factura con IA</h2>
      <button class="close-btn" (click)="closeFacturaModal()">‚úï</button>
    </div>
    
    <div class="modal-body">
      <div class="factura-upload-section">
        <p class="instruction">
          Sube una factura en PDF y la IA detectar√° autom√°ticamente los productos y cantidades para sumarlos al inventario.
        </p>
        
        <div class="file-upload-zone">
          <input 
            type="file" 
            id="facturaInput" 
            accept=".pdf" 
            (change)="onFacturaSelected($event)"
            style="display: none;">
          <label for="facturaInput" class="upload-label">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">
              <strong>Seleccionar Factura PDF</strong>
              <small>Solo archivos PDF (texto, no escaneados)</small>
            </div>
          </label>
          <span class="file-selected" *ngIf="facturaFileName">
            ‚úÖ {{ facturaFileName }}
          </span>
        </div>

        <button 
          class="btn-primary btn-upload" 
          (click)="procesarFactura()"
          [disabled]="!facturaFile || loadingFactura"
          style="width: 100%; margin-top: 20px; justify-content: center;">
          {{ loadingFactura ? '‚è≥ Procesando con IA...' : 'üöÄ Analizar Factura' }}
        </button>
      </div>

      <!-- Productos detectados -->
      <div class="productos-detectados" *ngIf="productosDetectados.length > 0">
        <h4>‚úÖ Productos Detectados ({{ productosDetectados.length }})</h4>
        <div class="table-responsive">
          <!-- En el modal de factura, reemplaza la tabla -->
<table class="mini-table">
  <thead>
    <tr>
      <th>C√≥digo</th>
      <th>Producto</th>
      <th>Cantidad</th>
      <th>Precio Unit.</th>
      <th>Total</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let prod of productosDetectados">
      <td><strong>{{ prod.codigo || '-' }}</strong></td>
      <td>{{ prod.nombre }}</td>
      <td><strong>{{ prod.cantidad }}</strong></td>
      <td>{{ prod.precio ? ('$' + prod.precio.toFixed(2)) : '-' }}</td>
      <td>{{ prod.total ? ('$' + prod.total.toFixed(2)) : '-' }}</td>
    </tr>
  </tbody>
</table>
        </div>

        <div class="alert alert-info">
          ‚ÑπÔ∏è Los productos se buscar√°n en el inventario por similitud de nombre. Las cantidades se <strong>SUMAR√ÅN</strong> al inventario actual (entrada de mercanc√≠a).
        </div>

        <button 
          class="btn-success btn-upload" 
          (click)="aplicarProductosDetectados()"
          style="width: 100%; margin-top: 15px; justify-content: center;">
          ‚úÖ Aplicar al Inventario (Sumar Cantidades)
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de C√≥digo de Barras -->
<div *ngIf="showBarcodeModal && productoBarcode" class="modal-overlay" (click)="closeBarcodeModal()">
  <div class="modal-content barcode-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>C√≥digo de Barras</h2>
      <button class="close-btn" (click)="closeBarcodeModal()">‚úï</button>
    </div>
    
    <div class="modal-body">
      <div class="barcode-display">
        <img 
          *ngIf="productoBarcode.barcodeDataUrl" 
          [src]="productoBarcode.barcodeDataUrl" 
          class="barcode-large"
        >
      </div>
      <div class="barcode-info">
        <h3>{{ productoBarcode.referencia }}</h3>
        <p>{{ productoBarcode.producto }}</p>
        <p class="codigo">{{ productoBarcode.codigo }}</p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeBarcodeModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal de Resultados de Importaci√≥n -->
<div *ngIf="showImportResultModal" class="modal-overlay" (click)="closeImportResultModal()">
  <div class="modal-content import-result-modal" (click)="$event.stopPropagation()">
    <div class="modal-header" [class.success]="importResult.nuevos > 0" [class.warning]="importResult.nuevos === 0">
      <h2>üìä Resultado de Importaci√≥n</h2>
      <button class="close-btn" (click)="closeImportResultModal()">‚úï</button>
    </div>
    
    <div class="modal-body">
      <div class="import-stats">
        <div class="import-stat new">
          <span class="import-icon">‚úÖ</span>
          <span class="import-value">{{ importResult.nuevos }}</span>
          <span class="import-label">Productos Nuevos</span>
        </div>
        <div class="import-stat existing">
          <span class="import-icon">‚è≠Ô∏è</span>
          <span class="import-value">{{ importResult.existentes }}</span>
          <span class="import-label">Ya Exist√≠an</span>
        </div>
        <div class="import-stat error" *ngIf="importResult.errores > 0">
          <span class="import-icon">‚ùå</span>
          <span class="import-value">{{ importResult.errores }}</span>
          <span class="import-label">Errores</span>
        </div>
      </div>

      <div class="import-message" *ngIf="importResult.nuevos > 0">
        <p>‚úÖ Se agregaron <strong>{{ importResult.nuevos }}</strong> productos nuevos a la base de datos.</p>
      </div>
      <div class="import-message" *ngIf="importResult.nuevos === 0 && importResult.existentes > 0">
        <p>‚ÑπÔ∏è Todos los productos del Excel ya existen en la base de datos.</p>
      </div>
      <div class="import-message warning" *ngIf="importResult.errores > 0">
        <p>‚ö†Ô∏è Hubo {{ importResult.errores }} errores al guardar algunos productos.</p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-primary" (click)="closeImportResultModal()">Entendido</button>
    </div>
  </div>
</div>