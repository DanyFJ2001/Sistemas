<!-- difusiones.component.html -->
<div class="difusiones-container">
  <div class="page-header">
    <div class="header-info">
      <h1 class="page-title">ğŸ“¢ Difusiones WhatsApp</h1>
      <p class="page-subtitle">EnvÃ­a mensajes masivos</p>
    </div>
    <div class="header-actions">
      <a routerLink="/bases-contactos" class="btn-secondary">ğŸ“‹ Gestionar Bases</a>
      <div class="status-badge" [ngClass]="estadoConexion">
        <span class="status-dot"></span>
        <span>{{ mensajeEstado }}</span>
      </div>
    </div>
  </div>

  <!-- SECCIÃ“N QR (si no estÃ¡ conectado) -->
  <section class="section-card" *ngIf="!whatsappConectado">
    <div class="section-header"><h2>ğŸ”— Conectar WhatsApp</h2></div>
    <div class="qr-container">
      <div *ngIf="estadoConexion === 'desconectado'" class="qr-placeholder">
        <div class="qr-icon">ğŸ“±</div>
        <h3>No conectado</h3>
        <button class="btn-primary" (click)="iniciarConexionWhatsApp()">Generar QR</button>
      </div>
      <div *ngIf="estadoConexion === 'esperando_qr'" class="qr-loading">
        <div class="spinner-lg"></div><p>Generando QR...</p>
      </div>
      <div *ngIf="estadoConexion === 'escaneando'" class="qr-display">
        <div class="qr-box"><div class="qr-mock">QR PLACEHOLDER</div></div>
        <div class="qr-actions">
          <button class="btn-secondary" (click)="iniciarConexionWhatsApp()">Regenerar</button>
          <button class="btn-success" (click)="simularConexionExitosa()">Simular (Dev)</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CONTENIDO PRINCIPAL (si conectado) -->
  <div class="main-content" *ngIf="whatsappConectado">
    <div class="conexion-bar">
      <span>âœ… WhatsApp conectado</span>
      <button class="btn-danger-sm" (click)="desconectarWhatsApp()">Desconectar</button>
    </div>

    <div class="content-grid">
      <!-- SELECTOR DE BASE -->
      <section class="section-card">
        <div class="section-header">
          <h2>ğŸ“‹ Contactos</h2>
          <a routerLink="/bases-contactos" class="btn-link">â• Nueva</a>
        </div>
        
        <div class="base-selector">
          <label>Base de datos:</label>
          <select class="form-select" [(ngModel)]="baseSeleccionadaId" (change)="onBaseSeleccionada()" *ngIf="!cargandoBases">
            <option value="">-- Selecciona --</option>
            <option *ngFor="let base of basesDisponibles" [value]="base.id">
              {{ base.nombre }} ({{ base.totalContactos }})
            </option>
          </select>
          <p *ngIf="cargandoBases">Cargando...</p>
          <p *ngIf="!cargandoBases && basesDisponibles.length === 0">
            No hay bases. <a routerLink="/bases-contactos">Crea una</a>
          </p>
        </div>

        <!-- Lista contactos -->
        <div class="contactos-list" *ngIf="contactos.length > 0">
          <div class="contactos-toolbar">
            <input type="text" [(ngModel)]="busquedaContacto" (input)="filtrarContactos()" placeholder="Buscar...">
            <label><input type="checkbox" [checked]="todosSeleccionados" (change)="toggleSeleccionTodos()"> Todos</label>
          </div>
          <div class="contactos-table">
            <div class="table-row" *ngFor="let c of contactosFiltrados">
              <input type="checkbox" [(ngModel)]="c.seleccionado">
              <span>{{ formatearTelefono(c.telefono) }}</span>
              <span>{{ c.nombre || 'â€”' }}</span>
            </div>
          </div>
          <div class="contactos-footer">{{ contactosSeleccionados.length }} seleccionados</div>
        </div>
      </section>

      <!-- MENSAJE -->
      <section class="section-card">
        <div class="section-header"><h2>âœï¸ Mensaje</h2></div>
        <textarea class="mensaje-textarea" [(ngModel)]="mensajeTexto" placeholder="Escribe tu mensaje..." rows="5" [disabled]="enviando"></textarea>
        
        <div class="imagen-adjunta">
          <div *ngIf="imagenPreview" class="imagen-preview">
            <img [src]="imagenPreview">
            <button (click)="eliminarImagen()">âœ•</button>
          </div>
          <div *ngIf="!imagenPreview">
            <input type="file" id="imgInput" accept="image/*" (change)="onImagenSeleccionada($event)" class="file-input">
            <label for="imgInput" class="btn-secondary">ğŸ–¼ï¸ Adjuntar</label>
          </div>
        </div>

        <div class="envio-actions">
          <span *ngIf="contactosSeleccionados.length > 0">ğŸ“¤ {{ contactosSeleccionados.length }} contactos</span>
          <button class="btn-primary" [disabled]="enviando || contactosSeleccionados.length === 0" (click)="iniciarEnvio()">
            {{ enviando ? 'Enviando...' : 'ğŸš€ Enviar' }}
          </button>
        </div>

        <div class="envio-progreso" *ngIf="enviando">
          <div class="progress-bar"><div class="progress-fill" [style.width.%]="progresoEnvio"></div></div>
          <p>âœ… {{ mensajesEnviados }} | âŒ {{ mensajesFallidos }}</p>
          <button class="btn-danger" (click)="cancelarEnvio()">Cancelar</button>
        </div>
      </section>
    </div>

    <!-- HISTORIAL -->
    <section class="section-card" *ngIf="historialEnvios.length > 0">
      <div class="section-header">
        <h2>ğŸ“œ Historial</h2>
        <button class="btn-secondary-sm" (click)="limpiarHistorial()">Limpiar</button>
      </div>
      <div class="historial-row" *ngFor="let e of historialEnvios">
        <span>{{ formatearFecha(e.fecha) }}</span>
        <span>{{ e.base }}</span>
        <span>ğŸ‘¥{{ e.contactos }} âœ…{{ e.enviados }} âŒ{{ e.fallidos }}</span>
      </div>
    </section>
  </div>
</div>