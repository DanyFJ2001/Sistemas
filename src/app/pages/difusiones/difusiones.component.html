<!-- src/app/pages/difusiones/difusiones.component.html -->
<div class="difusiones-container">

  <!-- ============================================== -->
  <!-- HEADER                                         -->
  <!-- ============================================== -->
  <div class="page-header">
    <div class="header-info">
      <h1 class="page-title">ğŸ“¢ Difusiones WhatsApp</h1>
      <p class="page-subtitle">EnvÃ­a mensajes masivos a tus contactos</p>
    </div>

    <div class="header-status">
      <div class="status-badge" [ngClass]="estadoConexion">
        <span class="status-dot"></span>
        <span class="status-text">{{ mensajeEstado }}</span>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- SECCIÃ“N 1: CONEXIÃ“N WHATSAPP (QR)              -->
  <!-- ============================================== -->
  <section class="section-card conexion-section" *ngIf="!whatsappConectado">
    <div class="section-header">
      <h2>ğŸ”— Conectar WhatsApp</h2>
      <p>Vincula tu cuenta de WhatsApp para enviar mensajes</p>
    </div>

    <div class="qr-container">
      <!-- Estado: Desconectado -->
      <div class="qr-placeholder" *ngIf="estadoConexion === 'desconectado'">
        <div class="qr-icon">ğŸ“±</div>
        <h3>WhatsApp no conectado</h3>
        <p>Haz clic en el botÃ³n para generar el cÃ³digo QR</p>
        <button class="btn-primary btn-lg" (click)="iniciarConexionWhatsApp()">
          <span class="btn-icon">ğŸ”„</span>
          Generar CÃ³digo QR
        </button>
      </div>

      <!-- Estado: Esperando QR -->
      <div class="qr-loading" *ngIf="estadoConexion === 'esperando_qr'">
        <div class="spinner-lg"></div>
        <p>Generando cÃ³digo QR...</p>
      </div>

      <!-- Estado: Mostrando QR -->
      <div class="qr-display" *ngIf="estadoConexion === 'escaneando'">
        <div class="qr-box">
          <!-- TODO: AquÃ­ va el QR real del backend -->
          <div class="qr-mock">
            <svg viewBox="0 0 100 100" class="qr-svg">
              <rect fill="#fff" width="100" height="100"/>
              <text x="50" y="45" text-anchor="middle" font-size="8" fill="#666">QR CODE</text>
              <text x="50" y="58" text-anchor="middle" font-size="6" fill="#999">Placeholder</text>
            </svg>
            <p class="qr-hint">ğŸ‘† AquÃ­ aparecerÃ¡ el QR real</p>
          </div>
          
          <!-- Si tienes el QR real, usa esto:
          <img [src]="qrCodeUrl" alt="CÃ³digo QR WhatsApp" class="qr-image">
          -->
        </div>
        
        <div class="qr-instructions">
          <h3>ğŸ“² Escanea con WhatsApp</h3>
          <ol>
            <li>Abre WhatsApp en tu telÃ©fono</li>
            <li>Toca <strong>MenÃº</strong> o <strong>ConfiguraciÃ³n</strong></li>
            <li>Selecciona <strong>Dispositivos vinculados</strong></li>
            <li>Toca <strong>Vincular un dispositivo</strong></li>
            <li>Apunta tu telÃ©fono a esta pantalla</li>
          </ol>
        </div>

        <div class="qr-actions">
          <button class="btn-secondary" (click)="iniciarConexionWhatsApp()">
            ğŸ”„ Regenerar QR
          </button>
          <!-- Para desarrollo -->
          <button class="btn-success" (click)="simularConexionExitosa()">
            âœ… Simular ConexiÃ³n (Dev)
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================================== -->
  <!-- CONTENIDO PRINCIPAL (Solo si estÃ¡ conectado)   -->
  <!-- ============================================== -->
  <div class="main-content" *ngIf="whatsappConectado">
    
    <!-- Barra de conexiÃ³n -->
    <div class="conexion-bar">
      <div class="conexion-info">
        <span class="conexion-icon">âœ…</span>
        <span>WhatsApp conectado y listo</span>
      </div>
      <button class="btn-danger-sm" (click)="desconectarWhatsApp()">
        ğŸ”Œ Desconectar
      </button>
    </div>

    <div class="content-grid">
      
      <!-- ============================================== -->
      <!-- SECCIÃ“N 2: CARGA DE CONTACTOS (EXCEL)          -->
      <!-- ============================================== -->
      <section class="section-card contactos-section">
        <div class="section-header">
          <h2>ğŸ“‹ Contactos</h2>
          <span class="badge-count">{{ contactos.length }} contactos</span>
        </div>

        <!-- Dropzone para Excel -->
        <div class="excel-upload">
          <div class="upload-zone">
            <div class="upload-icon">ğŸ“Š</div>
            <h3>Sube tu archivo de contactos</h3>
            <p>Excel (.xlsx, .xls) o CSV con nÃºmeros de telÃ©fono</p>
            <p class="upload-hint">Detectamos automÃ¡ticamente la columna de telÃ©fonos</p>
            
            <input type="file" id="excelInput" 
                   accept=".xlsx,.xls,.csv" 
                   (change)="onArchivoExcel($event)"
                   class="file-input">
            <label for="excelInput" class="btn-primary">
              ğŸ“ Seleccionar Archivo
            </label>
          </div>
        </div>

        <!-- Lista de contactos -->
        <div class="contactos-list" *ngIf="contactos.length > 0">
          <div class="contactos-toolbar">
            <div class="search-box">
              <span class="search-icon">ğŸ”</span>
              <input type="text" 
                     [(ngModel)]="busquedaContacto"
                     (input)="filtrarContactos()"
                     placeholder="Buscar contacto...">
            </div>
            
            <div class="toolbar-actions">
              <label class="checkbox-label">
                <input type="checkbox" 
                       [checked]="todosSeleccionados"
                       (change)="toggleSeleccionTodos()">
                Seleccionar todos
              </label>
              <button class="btn-danger-sm" (click)="limpiarContactos()">
                ğŸ—‘ï¸ Limpiar
              </button>
            </div>
          </div>

          <div class="contactos-table">
            <div class="table-header">
              <div class="th-check"></div>
              <div class="th-telefono">TelÃ©fono</div>
              <div class="th-nombre">Nombre</div>
              <div class="th-acciones">Acciones</div>
            </div>

            <div class="table-body">
              <div class="table-row" *ngFor="let contacto of contactosFiltrados">
                <div class="td-check">
                  <input type="checkbox" [(ngModel)]="contacto.seleccionado">
                </div>
                <div class="td-telefono">
                  <span class="telefono-badge">ğŸ“± {{ formatearTelefono(contacto.telefono) }}</span>
                </div>
                <div class="td-nombre">
                  {{ contacto.nombre || 'â€”' }}
                </div>
                <div class="td-acciones">
                  <button class="btn-icon-sm" (click)="eliminarContacto(contacto)" title="Eliminar">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="contactos-footer">
            <span class="selected-count">
              {{ contactosSeleccionados.length }} seleccionados
            </span>
          </div>
        </div>

        <!-- Sin contactos -->
        <div class="empty-contactos" *ngIf="contactos.length === 0">
          <div class="empty-icon">ğŸ“­</div>
          <p>No hay contactos cargados</p>
          <p class="empty-hint">Sube un archivo Excel o CSV para comenzar</p>
        </div>
      </section>

      <!-- ============================================== -->
      <!-- SECCIÃ“N 3: COMPOSITOR DE MENSAJE               -->
      <!-- ============================================== -->
      <section class="section-card mensaje-section">
        <div class="section-header">
          <h2>âœï¸ Mensaje</h2>
        </div>

        <div class="mensaje-composer">
          <!-- Ãrea de texto -->
          <div class="mensaje-input-container">
            <textarea 
              class="mensaje-textarea"
              [(ngModel)]="mensajeTexto"
              placeholder="Escribe tu mensaje aquÃ­...&#10;&#10;Puedes usar variables como {nombre} si tus contactos tienen nombres"
              rows="6"
              [disabled]="enviando"
            ></textarea>
            <div class="mensaje-counter">
              {{ mensajeTexto.length }} caracteres
            </div>
          </div>

          <!-- Adjuntar imagen -->
          <div class="imagen-adjunta">
            <div class="imagen-preview" *ngIf="imagenPreview">
              <img [src]="imagenPreview" alt="Imagen adjunta">
              <button class="btn-remove-img" (click)="eliminarImagen()">âœ•</button>
            </div>
            
            <div class="imagen-upload" *ngIf="!imagenPreview">
              <input type="file" id="imagenInput" 
                     accept="image/*"
                     (change)="onImagenSeleccionada($event)"
                     class="file-input">
              <label for="imagenInput" class="btn-secondary">
                ğŸ–¼ï¸ Adjuntar Imagen
              </label>
            </div>
          </div>

          <!-- BotÃ³n de envÃ­o -->
          <div class="envio-actions">
            <div class="envio-resumen" *ngIf="contactosSeleccionados.length > 0">
              <span>ğŸ“¤ Enviar a <strong>{{ contactosSeleccionados.length }}</strong> contactos</span>
            </div>
            
            <button 
              class="btn-primary btn-lg btn-enviar"
              [disabled]="enviando || contactosSeleccionados.length === 0 || (!mensajeTexto.trim() && !imagenAdjunta)"
              (click)="iniciarEnvio()"
            >
              <span *ngIf="!enviando">ğŸš€ Iniciar EnvÃ­o</span>
              <span *ngIf="enviando">
                <span class="spinner-sm"></span> Enviando...
              </span>
            </button>
          </div>

          <!-- Progreso de envÃ­o -->
          <div class="envio-progreso" *ngIf="enviando">
            <div class="progress-header">
              <span>Enviando mensajes...</span>
              <span>{{ progresoEnvio }}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="progresoEnvio"></div>
            </div>
            <div class="progress-stats">
              <span class="stat-success">âœ… {{ mensajesEnviados }} enviados</span>
              <span class="stat-error">âŒ {{ mensajesFallidos }} fallidos</span>
            </div>
            <button class="btn-danger" (click)="cancelarEnvio()">
              â¹ï¸ Cancelar
            </button>
          </div>
        </div>
      </section>

    </div>

    <!-- ============================================== -->
    <!-- SECCIÃ“N 4: HISTORIAL DE ENVÃOS                 -->
    <!-- ============================================== -->
    <section class="section-card historial-section" *ngIf="historialEnvios.length > 0">
      <div class="section-header">
        <h2>ğŸ“œ Historial de EnvÃ­os</h2>
        <button class="btn-secondary-sm" (click)="limpiarHistorial()">
          ğŸ—‘ï¸ Limpiar
        </button>
      </div>

      <div class="historial-table">
        <div class="historial-row" *ngFor="let envio of historialEnvios">
          <div class="historial-fecha">
            ğŸ“… {{ formatearFecha(envio.fecha) }}
          </div>
          <div class="historial-stats">
            <span class="stat-total">ğŸ‘¥ {{ envio.contactos }}</span>
            <span class="stat-ok">âœ… {{ envio.enviados }}</span>
            <span class="stat-fail">âŒ {{ envio.fallidos }}</span>
          </div>
          <div class="historial-mensaje">
            {{ envio.mensaje }}
            <span *ngIf="envio.conImagen">ğŸ–¼ï¸</span>
          </div>
        </div>
      </div>
    </section>

  </div>

</div>