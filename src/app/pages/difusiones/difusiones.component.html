<!-- src/app/pages/difusiones/difusiones.component.html -->
<div class="difusiones-container">
  
  <!-- HEADER -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <h1>üì¢ Difusiones</h1>
        <p>Env√≠a mensajes masivos por WhatsApp</p>
      </div>
      <div class="header-actions">
        <a routerLink="/bases-contactos" class="btn-icon">
          <span>üìã</span> Bases
        </a>
        <div class="status-badge" [ngClass]="whatsappConectado ? 'conectado' : 'desconectado'">
          <span class="status-dot"></span>
          <span>{{ mensajeEstado }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN QR - ESTILO WHATSAPP -->
  <section *ngIf="!whatsappConectado" class="qr-section">
    <div class="qr-wrapper">
      
      <!-- QR CARD -->
      <div class="qr-card">
        <div class="qr-header">
          <h2>Conecta WhatsApp</h2>
          <p>Escanea el c√≥digo QR con tu tel√©fono</p>
        </div>

        <!-- QR BOX -->
        <div class="qr-display" [ngSwitch]="estadoConexion">
          
          <!-- ESPERANDO QR -->
          <div *ngSwitchCase="'esperando_qr'" class="qr-loading">
            <div class="spinner"></div>
            <p>Generando QR...</p>
          </div>

          <!-- QR LISTO -->
          <div *ngSwitchCase="'escaneando'" class="qr-ready">
            <div class="qr-box" *ngIf="qrImagen">
              <img [src]="qrImagen" alt="WhatsApp QR Code" class="qr-img">
            </div>
            <div class="qr-info">
              <p><strong>1.</strong> Abre WhatsApp en tu tel√©fono</p>
              <p><strong>2.</strong> Toca Ajustes > Dispositivos vinculados</p>
              <p><strong>3.</strong> Escanea este c√≥digo</p>
            </div>
          </div>

          <!-- NO CONECTADO -->
          <div *ngSwitchDefault class="qr-not-ready">
            <div class="qr-icon">üì±</div>
            <p>No conectado</p>
            <button class="btn-primary" (click)="iniciarConexionWhatsApp()">
              Generar QR
            </button>
          </div>

        </div>

        <!-- FOOTER QR CARD -->
        <div class="qr-footer" *ngIf="estadoConexion === 'escaneando'">
          <button class="btn-secondary" (click)="iniciarConexionWhatsApp()">
            ‚Üª Nuevo QR
          </button>
        </div>
      </div>

    </div>
  </section>

  <!-- CONTENIDO PRINCIPAL (CONECTADO) -->
  <div class="main-content" *ngIf="whatsappConectado">
    
    <!-- CONEXION BAR -->
    <div class="conexion-bar">
      <span class="conexion-text">‚úÖ WhatsApp conectado y listo</span>
    </div>

    <!-- GRID PRINCIPAL -->
    <div class="content-grid">

      <!-- ============================================== -->
      <!-- COLUMNA 1: CONTACTOS                          -->
      <!-- ============================================== -->
      <section class="card">
        <div class="card-header">
          <h3>üë• Contactos</h3>
        </div>

        <div class="card-body">
          <!-- Selector de base -->
          <div class="form-group">
            <label>Base de datos</label>
            <select 
              class="form-select" 
              [(ngModel)]="baseSeleccionadaId" 
              (change)="onBaseSeleccionada()"
              *ngIf="!cargandoBases">
              <option value="">-- Selecciona una base --</option>
              <option *ngFor="let base of basesDisponibles" [value]="base.id">
                {{ base.nombre }} ({{ base.totalContactos }} contactos)
              </option>
            </select>
            <p *ngIf="cargandoBases" class="loading-text">Cargando bases...</p>
            <p *ngIf="!cargandoBases && basesDisponibles.length === 0" class="empty-text">
              No hay bases. <a routerLink="/bases-contactos">Crea una aqu√≠</a>
            </p>
          </div>

          <!-- Lista de contactos -->
          <div class="contactos-section" *ngIf="contactos.length > 0">
            <div class="contactos-controls">
              <input 
                type="text" 
                class="search-input"
                [(ngModel)]="busquedaContacto" 
                (input)="filtrarContactos()" 
                placeholder="Buscar...">
              <label class="checkbox-all">
                <input type="checkbox" [checked]="todosSeleccionados" (change)="toggleSeleccionTodos()">
                <span>Todos</span>
              </label>
            </div>

            <div class="contactos-list">
              <div class="contact-item" *ngFor="let c of contactosFiltrados">
                <input type="checkbox" [(ngModel)]="c.seleccionado">
                <div class="contact-info">
                  <span class="contact-phone">{{ formatearTelefono(c.telefono) }}</span>
                  <span class="contact-name" *ngIf="c.nombre">{{ c.nombre }}</span>
                </div>
              </div>
            </div>

            <div class="contactos-count">
              {{ contactosSeleccionados.length }} de {{ contactos.length }} seleccionados
            </div>
          </div>
        </div>
      </section>

      <!-- ============================================== -->
      <!-- COLUMNA 2: MENSAJE Y ENV√çO                    -->
      <!-- ============================================== -->
      <section class="card">
        <div class="card-header">
          <h3>‚úçÔ∏è Mensaje</h3>
        </div>

        <div class="card-body">

          <!-- TOGGLE IA -->
          <div class="ia-toggle">
            <span>ü§ñ Generar con IA</span>
            <label class="switch">
              <input type="checkbox" [(ngModel)]="usarIA">
              <span class="slider"></span>
            </label>
          </div>

          <!-- PANEL IA -->
          <div class="ia-panel" *ngIf="usarIA">
            <div class="form-group">
              <label>Contexto del negocio</label>
              <textarea 
                [(ngModel)]="contextoNegocio" 
                placeholder="Ej: Laboratorio cl√≠nico especializado en ex√°menes ocupacionales..."
                rows="2"
                [disabled]="enviando">
              </textarea>
            </div>

            <div class="form-group">
              <label>Objetivo del mensaje</label>
              <select [(ngModel)]="objetivoMensaje" [disabled]="enviando">
                <option value="">Selecciona...</option>
                <option value="promocion">üì¢ Promoci√≥n / Oferta</option>
                <option value="recordatorio">‚è∞ Recordatorio de cita</option>
                <option value="informativo">üìÑ Informativo</option>
                <option value="seguimiento">üîÑ Seguimiento</option>
                <option value="bienvenida">üëã Bienvenida</option>
                <option value="encuesta">üìä Encuesta / Feedback</option>
              </select>
            </div>

            <div class="form-group">
              <label>Instrucciones adicionales</label>
              <textarea 
                [(ngModel)]="instruccionesIA" 
                placeholder="Ej: Mencionar descuento del 20%, tono amigable..."
                rows="2"
                [disabled]="enviando">
              </textarea>
            </div>

            <div class="ia-buttons">
              <button 
                class="btn-ia"
                (click)="generarMensajeIA()" 
                [disabled]="generandoIA || !contextoNegocio || !objetivoMensaje">
                {{ generandoIA ? '‚è≥ Generando...' : '‚ú® Generar mensaje' }}
              </button>
              <button 
                class="btn-secondary"
                (click)="generarVariantes()" 
                *ngIf="mensajeTexto"
                [disabled]="generandoIA">
                üîÑ Variantes
              </button>
            </div>
          </div>

          <!-- TEXTAREA MENSAJE -->
          <div class="form-group">
            <label>Mensaje a enviar</label>
            <textarea 
              class="mensaje-input"
              [(ngModel)]="mensajeTexto" 
              placeholder="Escribe tu mensaje aqu√≠..." 
              rows="6"
              [disabled]="enviando">
            </textarea>
            <div class="char-count">{{ mensajeTexto.length }} caracteres</div>
          </div>

          <!-- IMAGEN -->
          <div class="image-section">
            <div *ngIf="imagenPreview" class="image-preview">
              <img [src]="imagenPreview" alt="Preview">
              <button class="btn-remove" (click)="eliminarImagen()">‚úï</button>
            </div>
            <div *ngIf="!imagenPreview" class="image-upload">
              <input type="file" id="imgInput" accept="image/*" (change)="onImagenSeleccionada($event)" hidden>
              <label for="imgInput" class="upload-label">
                <span>üñºÔ∏è Adjuntar imagen</span>
              </label>
            </div>
          </div>

          <!-- PROGRAMACI√ìN -->
          <div class="schedule-section">
            <div class="schedule-toggle">
              <span>‚è∞ Programar env√≠o</span>
              <label class="switch">
                <input type="checkbox" [(ngModel)]="programarEnvio">
                <span class="slider"></span>
              </label>
            </div>

            <div class="schedule-config" *ngIf="programarEnvio">
              <div class="schedule-grid">
                <div class="form-group">
                  <label>Tipo</label>
                  <select [(ngModel)]="tipoProgramacion" [disabled]="enviando">
                    <option value="ahora">Enviar ahora</option>
                    <option value="programado">Fecha espec√≠fica</option>
                  </select>
                </div>

                <div class="form-group" *ngIf="tipoProgramacion === 'programado'">
                  <label>Fecha y hora</label>
                  <input 
                    type="datetime-local" 
                    [(ngModel)]="nuevaFechaProgramacion"
                    [min]="getMinDateTime()"
                    [disabled]="enviando">
                </div>

                <div class="form-group" *ngIf="tipoProgramacion !== 'programado'">
                  <label>Hora inicio</label>
                  <input type="time" [(ngModel)]="horaInicio" [disabled]="enviando">
                </div>

                <div class="form-group" *ngIf="tipoProgramacion !== 'programado'">
                  <label>Hora fin</label>
                  <input type="time" [(ngModel)]="horaFin" [disabled]="enviando">
                </div>
              </div>
            </div>
          </div>

          <!-- BOTONES ENV√çO -->
          <div class="send-actions">
            <button 
              class="btn-secondary"
              (click)="previsualizarMensaje()" 
              [disabled]="!mensajeTexto || contactosSeleccionados.length === 0">
              üëÅÔ∏è Previsualizar
            </button>
            <button 
              class="btn-primary btn-large"
              [disabled]="enviando || contactosSeleccionados.length === 0 || !mensajeTexto" 
              (click)="iniciarEnvio()">
              <span *ngIf="!enviando">
                {{ programarEnvio && tipoProgramacion !== 'ahora' ? 'üìÖ Programar' : 'üöÄ Enviar ahora' }}
              </span>
              <span *ngIf="enviando">‚è≥ Enviando...</span>
            </button>
          </div>

          <!-- PROGRESO -->
          <div class="progress-section" *ngIf="enviando">
            <div class="progress-header">
              <span>Enviando mensajes...</span>
              <span class="progress-percent">{{ progresoEnvio | number:'1.0-0' }}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="progresoEnvio"></div>
            </div>
            <div class="progress-stats">
              <div>‚úÖ {{ mensajesEnviados }} enviados</div>
              <div>‚ùå {{ mensajesFallidos }} fallidos</div>
              <div>‚è≥ {{ contactosSeleccionados.length - mensajesEnviados - mensajesFallidos }} pendientes</div>
            </div>
            <button class="btn-danger" (click)="cancelarEnvio()">‚õî Cancelar</button>
          </div>

        </div>
      </section>

    </div>

    <!-- ============================================== -->
    <!-- SECCI√ìN: DIFUSIONES PROGRAMADAS               -->
    <!-- ============================================== -->
    <section class="card" *ngIf="mostrarNuevaProgramacion">
      <div class="card-header">
        <h3>üìÖ Difusiones Programadas</h3>
        <div class="header-stats">
          <span *ngIf="programacionesPendientes.length > 0">‚è≥ {{ programacionesPendientes.length }} pendientes</span>
          <span *ngIf="programacionesEjecutadas.length > 0">‚úÖ {{ programacionesEjecutadas.length }} ejecutadas</span>
        </div>
      </div>

      <div class="card-body">
        <div class="tabs">
          <button 
            class="tab-btn" 
            [class.active]="tabProgramaciones === 'pendientes'"
            (click)="tabProgramaciones = 'pendientes'">
            ‚è≥ Pendientes ({{ programacionesPendientes.length }})
          </button>
          <button 
            class="tab-btn" 
            [class.active]="tabProgramaciones === 'ejecutadas'"
            (click)="tabProgramaciones = 'ejecutadas'">
            ‚úÖ Ejecutadas ({{ programacionesEjecutadas.length }})
          </button>
        </div>

        <!-- PENDIENTES -->
        <div *ngIf="tabProgramaciones === 'pendientes'" class="tab-content">
          <div *ngIf="programacionesPendientes.length === 0" class="empty-state">
            <p>No hay difusiones programadas</p>
          </div>

          <div *ngFor="let prog of programacionesPendientes" class="prog-card">
            <div class="prog-header">
              <h4>{{ prog.name }}</h4>
              <span class="prog-time" [class.proximo]="estaProxima(prog.scheduledFor)">
                ‚è±Ô∏è {{ getTiempoRestante(prog.scheduledFor) }}
              </span>
            </div>
            <div class="prog-details">
              <p><strong>üìÖ</strong> {{ formatearFechaProgramada(prog.scheduledFor) }}</p>
              <p><strong>üë•</strong> {{ prog.contacts.length }} contactos</p>
            </div>
            <div class="prog-actions">
              <button class="btn-sm btn-edit" (click)="editarProgramacion(prog)">‚úèÔ∏è Editar</button>
              <button class="btn-sm btn-danger" (click)="cancelarProgramacion(prog.id)">‚ùå Cancelar</button>
            </div>
          </div>
        </div>

        <!-- EJECUTADAS -->
        <div *ngIf="tabProgramaciones === 'ejecutadas'" class="tab-content">
          <div *ngIf="programacionesEjecutadas.length === 0" class="empty-state">
            <p>No hay difusiones ejecutadas</p>
          </div>

          <div *ngFor="let prog of programacionesEjecutadas" class="prog-card ejecutada">
            <div class="prog-header">
              <h4>{{ prog.name }}</h4>
              <span class="badge-success">‚úÖ Ejecutada</span>
            </div>
            <div class="prog-details">
              <p><strong>üìÖ</strong> {{ formatearFechaProgramada(prog.executedAt || prog.scheduledFor) }}</p>
              <p><strong>üë•</strong> {{ prog.contacts.length }} contactos</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================================== -->
    <!-- HISTORIAL                                     -->
    <!-- ============================================== -->
    <section class="card" *ngIf="historialEnvios.length > 0">
      <div class="card-header">
        <h3>üìú Historial de env√≠os</h3>
        <button class="btn-sm" (click)="limpiarHistorial()">Limpiar</button>
      </div>

      <div class="card-body">
        <div class="history-list">
          <div class="history-item" *ngFor="let e of historialEnvios">
            <div class="history-time">{{ formatearFecha(e.fecha) }}</div>
            <div class="history-info">
              <strong>{{ e.base }}</strong>
              <span>üë•{{ e.contactos }} ‚úÖ{{ e.enviados }} ‚ùå{{ e.fallidos }}</span>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- ============================================== -->
  <!-- MODAL: EDITAR PROGRAMACI√ìN                     -->
  <!-- ============================================== -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="cerrarEditModal()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚úèÔ∏è Editar Programaci√≥n</h2>
        <button class="close-btn" (click)="cerrarEditModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Nueva fecha y hora</label>
          <input 
            type="datetime-local" 
            [(ngModel)]="nuevaFechaProgramacion"
            [min]="getMinDateTime()">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="cerrarEditModal()">Cancelar</button>
        <button class="btn-primary" (click)="guardarEditProgramacion()" [disabled]="!nuevaFechaProgramacion">
          üíæ Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- MODAL: PREVISUALIZACI√ìN                        -->
  <!-- ============================================== -->
  <div class="modal-overlay" *ngIf="showPreviewModal" (click)="cerrarPreviewModal()">
    <div class="preview-modal" (click)="$event.stopPropagation()">
      <div class="preview-header">
        <button class="back-btn" (click)="cerrarPreviewModal()">‚Üê</button>
        <h2>Previsualizaci√≥n</h2>
      </div>

      <div class="preview-phone">
        <div class="phone-frame">
          <div class="phone-header">
            <span class="phone-time">{{ getHoraActual() }}</span>
          </div>

          <div class="phone-chat">
            <div *ngIf="imagenPreview" class="msg-out">
              <img [src]="imagenPreview" alt="Imagen" class="msg-image">
            </div>
            <div class="msg-out">
              <div class="msg-text">{{ mensajePreview }}</div>
            </div>
          </div>
        </div>
      </div>

      <div class="preview-actions">
        <button class="btn-secondary" (click)="cerrarPreviewModal()">Cerrar</button>
        <button class="btn-primary" (click)="cerrarPreviewModal(); iniciarEnvio();">
          üöÄ Enviar a {{ contactosSeleccionados.length }}
        </button>
      </div>
    </div>
  </div>

</div>